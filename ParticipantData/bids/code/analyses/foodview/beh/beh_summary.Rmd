---
title: ""
author: "baf44"
date: ""
output: html_document
editor_options: 
  chunk_output_type: console
---

## Set up

```{r load file}
library(dplyr)
library(ggplot2)
```

```{r load data }

# load behavioral files generated by /ParticipantData/bids/code/beh_into_bids.R (run locally)

beh_byblock <- read.delim("~/Library/CloudStorage/OneDrive-ThePennsylvaniaStateUniversity/b-childfoodlab_Shared/Active_Studies/MarketingResilienceRO1_8242020/ParticipantData/bids/derivatives/beh_summary_databases/foodview_long_by_block.tsv", na.strings = "n/a")
beh_bycond <- read.delim("~/Library/CloudStorage/OneDrive-ThePennsylvaniaStateUniversity/b-childfoodlab_Shared/Active_Studies/MarketingResilienceRO1_8242020/ParticipantData/bids/derivatives/beh_summary_databases/foodview_long_by_cond.tsv", na.strings = "n/a")
```

# Data processing

Data was processed by dataREACHr functions util_task_foodview.R (called by proc_task.R) and deriv_foodview.R. The following cleaning steps occurred:

1.  Responses other than want/don't want (resulting from trigger interference for 2 subs), were re-coded as 0/'no response'; associated response times were replaced with NA

2.  Responses (want/don't want) with response time of 0 were re-coded as no responses due to this being an impossible response time (would result from button response being held down or getting stuck)

3.  Response times of 0 were removed (replaced with NA)

# Histograms - task completion
```{r run completion}

# count number of children with N runs completed
run_count <- beh_byblock %>% group_by(sub) %>% summarise(
  total_blocks = n(),
  n_runs = n()/4
) %>% group_by(n_runs) %>% summarise(
  n_subs = n()
)

# add 0 count for n_runs not in run_count
for (n in seq(1:4) ){
  if (!n %in% run_count$n_runs) {
    run_count = run_count %>% add_row(n_runs = n, n_subs = 0)
  }
}

ggplot(data=run_count, aes(x=n_runs, y=n_subs)) +
  geom_bar(stat="identity", width=0.5) +   
  ggtitle("Task completion") +
  xlab("Number of runs completed") +
  ylab("Number of children") +
  theme(plot.title = element_text(hjust = 0.5))


```

# Histograms - performance metrics

Histograms are produced for metrics derived by block of the food view task. The complete food view task included 16 blocks (4 per run). Each block included 5 image events, where children were instructed to indicate using a button response if they 'want' to 'do not want' the item depicted.

## Response rate

Response rate (p_resp) was calculated for each block as the proportion of trials with responses out of all trials in a given block (n=5).
```{r response rates}

# histagram of response rate with all subjects
hist(beh_byblock$p_resp, 
     main = "Response rate by block", 
     xlab = "Proportion of trials with responses",
     ylab = "Frequency (number of blocks)",
     breaks = 6)

# make list of sub-IDs with known technical response issues
response_issues = list(
  "sub-003" = "trigger interference",
  "sub-006" = "trigger interference",
  "sub-075" = "responses not collecting",
  "sub-037" = "stuck button (run1); confusion about pointer finger (runs 2-3)"
)

# subset data to remove children with technical response issues
beh_byblock_reduced <- beh_byblock[!beh_byblock$sub %in% names(response_issues),]

# histagram of response rate after removing subs with known response issues
hist(beh_byblock_reduced$p_resp, 
     main = "Response rate - remove subs with technical issues", 
     xlab = "Proportion of trials with responses",
     ylab = "Frequency (number of blocks)",
     breaks = 6)

```

## Proportion Wanting

Wanting (p_want_of_resp) was calculated for each block as the proportion of trials with 'want' responses out of the total number of responses in a given block

```{r wanting}

# # histograms with base R
# want_hist_toy <- hist(beh_byblock[beh_byblock$commerical_cond == 'toy',]$p_want_of_resp)
# want_hist_food <- hist(beh_byblock[beh_byblock$commerical_cond == 'food',]$p_want_of_resp)
# 
# plot(want_hist_toy, col=rgb(0,0,1,1/4), xlim=c(0,1))  # first histogram
# plot(want_hist_food, col=rgb(1,0,0,1/4), xlim=c(0,1), add=T)  # second

# # density plot by commerical condition
# ggplot(beh_byblock, aes(p_want_of_resp, fill = commerical_cond)) + 
#    geom_histogram(alpha = 0.5, aes(y = ..density..), position = 'identity', bins = 10)  + geom_density(alpha = 0.2)

# histograms by commerical condition
ggplot(beh_byblock, aes(p_want_of_resp, fill = commerical_cond)) + 
  geom_histogram(alpha = 0.5, aes(), position = 'identity', bins = 8) + scale_fill_manual(values=c("#F8766D", "#00A9FF")) + 
  ggtitle("Wanting by Commerical Condition")  +
  xlab("Proportion of 'want' responses / total responses") +
  ylab("Number of blocks") +
  theme(plot.title = element_text(hjust = 0.5))

# histograms by by energy density
ggplot(beh_byblock, aes(p_want_of_resp, fill = food_ed)) + 
  geom_histogram(alpha = 0.5, aes(), position = 'identity', bins = 8) + scale_fill_manual(values=c("#C77CFF", "#00BA38")) + 
  ggtitle("Wanting by Food Energy Density") +
  xlab("Proportion of 'want' responses / total responses") +
  ylab("Number of blocks") +
  theme(plot.title = element_text(hjust = 0.5))

# histograms by by taste (sweet, savory)
ggplot(beh_byblock, aes(p_want_of_resp, fill = food_taste)) + 
  geom_histogram(alpha = 0.5, aes(), position = 'identity', bins = 8) + scale_fill_manual(values=c("#E68613", "#00BFC4")) + 
  ggtitle("Wanting by Food Taste")  +
  xlab("Proportion of 'want' responses / total responses") +
  ylab("Number of blocks") +
  theme(plot.title = element_text(hjust = 0.5))
```

## Average response times

Average response time (avg_rt) was calculated for all non-NA response times within each block.

```{r response time}
ggplot(beh_byblock, aes(avg_rt, fill = commerical_cond)) + 
  geom_histogram(alpha = 0.5, aes(), position = 'identity', bins = 8) + scale_fill_manual(values=c("#F8766D", "#00A9FF")) + 
  ggtitle("Average Response Time by Commerical Condition")  +
  xlab("Average RT within a block (ms)") +
  ylab("Number of blocks") +
  theme(plot.title = element_text(hjust = 0.5))

# histograms by by energy density
ggplot(beh_byblock, aes(avg_rt, fill = food_ed)) + 
  geom_histogram(alpha = 0.5, aes(), position = 'identity', bins = 8) + scale_fill_manual(values=c("#C77CFF", "#00BA38")) + 
  ggtitle("Average Response Time  Food Energy Density") +
  xlab("Average RT within a block (ms)") +
  ylab("Number of blocks") +
  theme(plot.title = element_text(hjust = 0.5))


# histograms by by taste (sweet, savory)
ggplot(beh_byblock, aes(avg_rt, fill = food_taste)) + 
  geom_histogram(alpha = 0.5, aes(), position = 'identity', bins = 8) + scale_fill_manual(values=c("#E68613", "#00BFC4")) + 
  ggtitle("Average Response Time by Food Taste")  +
  xlab("Average RT within a block (ms)") +
  ylab("Number of blocks") +
  theme(plot.title = element_text(hjust = 0.5))


```
